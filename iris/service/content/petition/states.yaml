states:
    - name: draft
      on_enter:
        - not_listable
      transitions:
        - trigger: publish
          dest: supportable.pending
          before:
            - check_publish
          after:
            # let the publisher support the petition
            - support_petition_on_publish

    - name: rejected
      on_enter:
        - send_rejected_mail_to_owner
        - not_listable
      transitions:
        - trigger: publish
          dest: supportable.pending
          before:
            - check_publish
          after:
            # let the publisher support the petition
            - support_petition_on_publish

    - name: supportable
      on_enter:
        - start_support
        - listable
      children:
          - name: pending
            on_enter:
                - start_support
                - not_listable
                - send_approval_request_to_editor
            transitions:
                - trigger: approved
                  dest: supportable.active
                  conditions:
                    - if_city_assigned
                - trigger: reject
                  dest: rejected
                - trigger: support
                  after:
                    - support_petition
                  dest: supportable.pending
          - name: active
            on_enter:
                - listable
                - enable_tick
            on_exit:
                - disable_tick
            transitions:
                - trigger: check
                  dest: supportable.winner
                  conditions:
                      - if_supporter_limit_reached
                - trigger: tick
                  dest: loser
                  conditions:
                      - if_support_timeout
                - trigger: support
                  after:
                    - support_petition
                  dest: supportable.active
          - name: winner
            on_enter:
                - send_winner_mail_to_owner
                - listable
                - enable_tick
            on_exit:
                - disable_tick
            transitions:
                - trigger: tick
                  dest: processing.sendLetterRequested
                  conditions:
                      - if_support_timeout
                - trigger: support
                  after:
                    - support_petition
                  dest: supportable.winner

    - name: processing
      children:
          - name: sendLetterRequested
            on_enter:
                - listable
                - set_response_token
            transitions:
                - trigger: letterSent
                  dest: processing.waitForLetterResponse
          - name: waitForLetterResponse
            on_enter:
                - listable
                - set_response_token
            transitions:
                - trigger: setFeedback
                  conditions:
                      - if_feedback_has_valid_token
                  after:
                    - set_petition_feedback
                  dest: processing.letterResponseArrived
          - name: letterResponseArrived
            on_enter:
                - listable
                - reset_response_token
            transitions:
                - trigger: close
                  dest: closed

    - name: loser
    - name: closed
    - name: deleted
      on_enter:
        - not_listable


transitions:
    - trigger: reset
      source: '*'
      dest: draft
    - trigger: delete
      source: '*'
      dest: deleted
